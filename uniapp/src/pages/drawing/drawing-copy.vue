<template>    <view class="drawing-container">        <u-tabs            :list="tabsState.lists"            :is-scroll="true"            :current="tabsState.current"            active-color="#FFFFFF"            inactive-color="#AEAEAE"            bg-color="transparent"            :barStyle="{                background: '#FFC94D'            }"            @change="handleChange"        ></u-tabs>        <view class="drawing-content h-full">            <swiper                class="swiper"                duration="200"                :current="tabsState.current"                @animationfinish="swiperAnimationfinish"            >                <swiper-item                    class="swiper-item"                    v-for="(item, index) in tabsState.lists"                    :key="index"                >                    <DrawingControl                        v-if="index == 0"                        v-model="formData"                        @drawing="drawingHandler"                    >                    </DrawingControl>                    <DrawingRecord                        v-if="index == 1"                        v-model="drawingResult"                        v-model:current="recordState.current"                        :isReceiving="isReceiving"                        :contentList="recordState.lists"                        :drawingStatusText="drawingStatusText"                        @change="choiceRecord"                        @drawing="drawingHandler"                        @delete="deleteHandler"                    >                    </DrawingRecord>                </swiper-item>            </swiper>        </view>    </view></template><script lang="ts" setup>import { reactive, ref } from 'vue'import { onShow } from '@dcloudio/uni-app'import type { DrawingFormType } from '@/api/drawing'import { drawing, drawingRecord, drawingDelete } from '@/api/drawing'import DrawingControl from '@/pages/drawing/component/drawing-control.vue'import DrawingRecord from '@/pages/drawing/component/drawing-record.vue'import { useUserStore } from '@/stores/user'import { useRouter } from 'uniapp-router-next'import { useLockFn } from '@/hooks/useLockFn'const router = useRouter()const userStore = useUserStore()const tabsState = reactive({    current: 0,    lists: [        {            name: 'AI绘画',            value: 0        },        {            name: '生成记录',            value: 0        }    ]})// 是否正在接收const isReceiving = ref<boolean>(false)// 绘制状态提示const drawingStatusText = reactive<any>({    title: '生成的图片将会显示在这里',    content: '在左侧输入描述，创建你的作品吧'})// 记录状态const recordState = reactive<any>({    current: 0,    lists: []})// 绘制结果const drawingResult = reactive<any>({    actions: [],    prompt: '',    progress: 0,    task_id: '',    image_id: '',    image_url: ''})// 绘制参数（初始化餐素const initialData: DrawingFormType = {    prompt: '',    action: 'generate',    image_base: '',    image_id: '',    scale: '1:1'}// 转为reactiveconst formData = reactive<DrawingFormType>(Object.assign({}, initialData))const handleChange = (index: number) => {    tabsState.current = index}const swiperAnimationfinish = (e: any) => {    tabsState.current = e.detail.current}/** *  选择绘图记录 *  **/const choiceRecord = (row: any) => {    Reflect.ownKeys(row).map((item: any) => {        drawingResult[item] = row[item]    })}/** *  绘制记录 *  **/const getDrawingRecord = async () => {    try {        const lists = await drawingRecord({})        if (lists.length != 0) {            Reflect.ownKeys(lists[0]).map((item: any) => {                drawingResult[item] = lists[0][item]            })        }        recordState.lists = lists        console.log(drawingResult)    } catch (error) {        console.log('获取绘画记录失败=>', error)    }}/** *  删除绘图 *  **/const deleteHandler = async (id: number) => {    try {        await drawingDelete({            ids: [id]        })        await getDrawingRecord()    } catch (error) {        console.log('删除绘画记录失败=>', error)    }}/** *  绘制请求 *  options: { drawing } : 绘制参数 *  options: { isClear } : 是否清空绘制参数 **/const { lockFn: drawingHandler, isLock } = useLockFn(    async (options: { drawing: DrawingFormType; isClear: boolean }) => {        console.log(options.drawing)        if (isReceiving.value) {            tabsState.current = 1            return        }        if (!userStore.isLogin) {            return router.navigateTo('/pages/login/login')        }        if (!options.drawing.prompt) return uni.$u.toast('请输入绘画描述！')        isReceiving.value = true        tabsState.current = 1        // 添加插入一个空的绘画结果        recordState.current = 0        drawingResult.image_url = ''        recordState.lists.unshift({ ...drawingResult, image_url: '' })        try {            await drawing(options.drawing, {                onstart(reader) {},                onmessage(value) {                    console.log(value)                    value                        .trim()                        .split('data: ')                        .forEach(async (text) => {                            if (text !== '') {                                try {                                    const data = JSON.parse(text)                                    // 小程序中暂时写成这样                                    if (data?.code == 0) {                                        if (data.msg == '余额不足') {                                            toRecharge()                                        }                                        drawErrorHandler(data.msg)                                        return                                    }                                    Reflect.ownKeys(data).map((item: any) => {                                        drawingResult[item] = data[item]                                    })                                    recordState.lists[0] = drawingResult                                    // 结束时                                    if (data.prompt) {                                        await getDrawingRecord()                                        drawingResult.prompt = data.prompt                                        isReceiving.value = false                                        recordState.current = 0                                        drawingResult.progress = 0                                    }                                } catch (error) {                                    console.log('转化数据失败=>', error)                                }                            }                        })                },                async onclose() {}            })            // 重置参数            if (options.isClear) Object.assign(formData, initialData)        } catch (error) {            if (error == '余额不足') {                toRecharge()            }            drawErrorHandler(error ?? '错误超时')        }    })// 去充值const toRecharge = async () => {    const res = await uni.showModal({        title: '绘画余额不足',        content: '绘画余额不足，请前往充值',        confirmText: '前往充值'    })    if (res.confirm) {        if (userStore.isLogin) {            router.navigateTo('/packages/pages/recharge/recharge')        } else {            router.navigateTo('/pages/login/login')        }    }}// 绘制错误的处理const drawErrorHandler = (error: any) => {    isReceiving.value = false    recordState.current = -1    drawingStatusText.title = '错误提示'    if (error?.errno != 5) {        drawingStatusText.content = error    } else {        drawingStatusText.content = '响应超时'    }    recordState.lists.splice(0, 1)    console.log('绘制失败=>', error)}onShow(() => { getDrawingRecord() })</script><style lang="scss">page {  height: 100%;}.drawing-container {  display: flex;  flex-direction: column;  flex: 1;  height: 100%;  background-color: #1f2128;  .swiper {    width: 100%;    height: 100%;    &-item {      width: 100%;      height: 100%;    }  }}</style>